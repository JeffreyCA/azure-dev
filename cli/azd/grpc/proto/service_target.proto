syntax = "proto3";

package azdext;

option go_package = "github.com/azure/azure-dev/cli/azd/pkg/azdext";

import "include/google/protobuf/struct.proto";

service ServiceTargetService {
  // Bidirectional stream for service target requests and responses
  rpc Stream(stream ServiceTargetMessage) returns (stream ServiceTargetMessage);
}

// Envelope for all possible service target messages (requests and responses)
message ServiceTargetMessage {
  string request_id = 1;
  ServiceTargetErrorMessage error = 99;
  oneof message_type {
    RegisterServiceTargetRequest register_service_target_request = 2;
    RegisterServiceTargetResponse register_service_target_response = 3;
    // ServiceTargetNameRequest name_request = 4;
    // ServiceTargetNameResponse name_response = 5;
    // ServiceTargetInitializeRequest initialize_request = 6;
    // ServiceTargetInitializeResponse initialize_response = 7;
    // ServiceTargetStateRequest state_request = 8;
    // ServiceTargetStateResponse state_response = 9;
    GetTargetResourceRequest get_target_resource_request = 10;
    GetTargetResourceResponse get_target_resource_response = 11;
    ServiceTargetDeployRequest deploy_request = 12;
    ServiceTargetDeployResponse deploy_response = 13;
  }
}

// State
message ServiceTargetState {
  map<string, ServiceTargetOutputParameter> outputs = 1;
  repeated ServiceTargetResource resources = 2;
}

// InputParameter
message ServiceTargetInputParameter {
  string type = 1;
  string default_value = 2;
  string value = 3;
}

// OutputParameter
message ServiceTargetOutputParameter {
  string type = 1;
  string value = 2;
}

// Resource
message ServiceTargetResource {
  string id = 1;
}

// --- Request and response messages for each Provider method ---

message ServiceTargetNameRequest {}
message ServiceTargetNameResponse {
  string name = 1;
}

message ServiceTargetInitializeRequest {
  string project_path = 1;
  ServiceTargetOptions options = 2;
}
message ServiceTargetInitializeResponse {}

message ServiceTargetStateRequest {
  ServiceTargetStateOptions options = 1;
}
message ServiceTargetStateResponse {
  ServiceTargetStateResult state_result = 1;
}

// Core options and result wrappers
message ServiceTargetOptions {
  string provider = 1;
  string path = 2;
  string module = 3;
  map<string, string> deployment_stacks = 4;
  bool ignore_deployment_state = 5;
  google.protobuf.Struct config = 6;
}

message ServiceTargetStateOptions {
  // Add fields as needed
  string hint = 1;
}

message ServiceTargetStateResult {
  ServiceTargetState state = 1;
}

message RegisterServiceTargetRequest {
  string host = 1;// unique identifier for the provider
  // string display_name = 2;
}

message RegisterServiceTargetResponse {
  // Add fields as needed (empty for now)
}

message ServiceTargetErrorMessage {
  string message = 2;
  string details = 3;
}

// GetTargetResource request and response
message GetTargetResourceRequest {
  string subscription_id = 1;
  ServiceTargetConfig service_config = 2;
}

message GetTargetResourceResponse {
  TargetResource target_resource = 1;
}

// ServiceTargetConfig represents the service configuration needed for target resource resolution
message ServiceTargetConfig {
  string name = 1;
  string host = 2;
  string project_name = 3;
  ResourceGroupNameTemplate resource_group_name = 4;
  ResourceGroupNameTemplate project_resource_group_name = 5;
}

// ResourceGroupNameTemplate represents a resource group name template
message ResourceGroupNameTemplate {
  string template = 1;
  bool is_empty = 2;
}

// TargetResource represents the resolved target resource
message TargetResource {
  string subscription_id = 1;
  string resource_group_name = 2;
  string resource_name = 3;
  string resource_type = 4;
}

// Deploy request and response
message ServiceTargetDeployRequest {
  ServiceTargetConfig service_config = 1;
  ServiceTargetPackageResult service_package = 2;
  TargetResource target_resource = 3;
}

message ServiceTargetDeployResponse {
  ServiceTargetDeployResult deploy_result = 1;
}

// ServiceTargetPackageResult represents the package result for deployment
message ServiceTargetPackageResult {
  string package_path = 1;
  map<string, string> details = 2;
}

// ServiceTargetDeployResult represents the result of a deployment operation
message ServiceTargetDeployResult {
  ServiceTargetPackageResult package = 1;
  string target_resource_id = 2;
  string kind = 3;
  repeated string endpoints = 4;
  string details = 5;
}


